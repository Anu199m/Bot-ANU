const axios = require("axios");
const fs = require("fs");
const path = require("path");

module.exports.config = {
    name: "findmovie",
    version: "1.0.6",
    hasPermission: 0,
    credits: "uzairrajput",
    description: "Find movie or series details from IMDb",
    commandCategory: "search",
    usages: "[movie/series name]",
    cooldowns: 3
};

module.exports.run = async ({ event, args, api }) => {
    if (!args.length) {
        return api.sendMessage("‚ùóBaraye karam film ya series ka name darj karo!", event.threadID, event.messageID);
    }

    const query = args.join(" ");
    const apiKey = "f02457d8"; // apna IMDb API Key Deal 
    const url = `http://www.omdbapi.com/?t=${encodeURIComponent(query)}&apikey=${apiKey}`;

    try {
        const response = await axios.get(url);
        const data = response.data;

        if (data.Response === "False") {
            return api.sendMessage(`‚ùå IMDb kar *${query}* Iske mutalek koi malumat nahi `, event.threadID, event.messageID);
        }

        // üé¨ pehle Movie Info Bejen
        const message = `üé¨ *${data.Title}* (${data.Year})\n‚≠ê IMDB Daja bandi: ${data.imdbRating}/10\nüé≠ Genre: ${data.Genre}\nüé¨ Director: ${data.Director}\nüìú Khahani: ${data.Plot}\nüåç Malik: ${data.Country}\n\nüîó IMDb: https://www.imdb.com/title/${data.imdbID}/`;
        api.sendMessage(message, event.threadID, event.messageID);

        // üé• Aghr Poster Aghr ap mojod hai to download our bejon 
        if (data.Poster && data.Poster !== "N/A") {
            const cacheDir = path.join(__dirname, "cache");
            if (!fs.existsSync(cacheDir)) fs.mkdirSync(cacheDir); // aghr cache Aghr apke pass folder nahi hai to is ko banaya 

            const filePath = path.join(cacheDir, `${data.Title.replace(/[^a-zA-Z0-9]/g, "_")}.jpg`);

            const writer = fs.createWriteStream(filePath);
            const imageResponse = await axios({
                url: data.Poster,
                method: "GET",
                responseType: "stream"
            });

            imageResponse.data.pipe(writer);

            writer.on("finish", () => {
                api.sendMessage({ body: "üéû Movie Poster:", attachment: fs.createReadStream(filePath) }, event.threadID, () => {
                    setTimeout(() => {
                        fs.unlink(filePath, (err) => {
                            if (err) console.error("‚ùå Poster delete failed:", err);
                        });
                    }, 5000); // 5 Dosra ke bad auto tafselat
                });
            });

            writer.on("error", (err) => {
                console.error(err);
                api.sendMessage("‚ö†Ô∏è Poster Download Karna ka malsa hai !", event.threadID, event.messageID);
            });
        }
    } catch (error) {
        console.error(error);
        return api.sendMessage("‚ö†Ô∏è IMDb API Se data lana main ek masla hai bad main: Koshish kar raha hu!", event.threadID, event.messageID);
    }
};